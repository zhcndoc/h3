---
date: 2023-08-15
category: release
authors:
  - name: Pooya Parsa
    github: pi0
---

# H3 1.8 - è¿ˆå‘ Web çš„è¾¹ç¼˜

> å…¨æ–° H3 ç‰ˆæœ¬å‘å¸ƒï¼Œæ”¯æŒ web å’Œ plain é€‚é…å™¨ï¼Œæ”¯æŒ web æµï¼Œå¯¹è±¡è¯­æ³•äº‹ä»¶å¤„ç†å™¨ï¼Œç±»å‹åŒ–äº‹ä»¶å¤„ç†è¯·æ±‚ç­‰æ›´å¤šåŠŸèƒ½ï¼

> [H3](/packages/h3) æ˜¯ä¸€ä¸ªç”¨ TypeScript ç¼–å†™çš„å¤šåŠŸèƒ½ H(TTP) æ¡†æ¶ï¼Œç°å·²é©±åŠ¨ [Nitro](https://nitro.unjs.io/) å’Œ [Nuxt](https://nuxt.com/)ã€‚

[è¿‘ä¸¤å¹´å‰](https://github.com/unjs/h3/tree/cbc8909b2003d6d5df694ab7a36aa067cc990c74)ï¼Œæˆ‘ä»¬æ€€ç€æˆä¸º [Nuxt 3](https://nuxt.com/) ä¸­æœ€å°å‹ HTTP æ¡†æ¶çš„ç›®æ ‡åˆ›å»ºäº† H3ï¼Œç¡®ä¿å…¶ä¸ [Node.js](https://nodejs.org/en) å…¼å®¹å¹¶æä¾›ä¼˜é›…çš„å¼€å‘ä½“éªŒã€‚åŒæ—¶ï¼Œå®ƒè¿˜æ—¨åœ¨å…·å¤‡é¢å‘æœªæ¥çš„è®¾è®¡ï¼Œèƒ½å¤Ÿé€‚é… Edge å’Œ Web Worker è¿è¡Œæ—¶ï¼Œè¿™åœ¨å½“æ—¶æ˜¯ç›¸å¯¹è¾ƒæ–°çš„æ¦‚å¿µã€‚

åŒæœŸï¼Œæˆ‘ä»¬è¿˜å¼€å‘äº† [unjs/unenv](https://github.com/unjs/unenv/tree/main)ï¼Œè¿™æ˜¯ä¸€ä¸ªè½»é‡å±‚ï¼Œå…è®¸åœ¨æ— éœ€ Node.js çš„æƒ…å†µä¸‹ï¼Œåœ¨ Edge å…¼å®¹è¿è¡Œæ—¶ä¸Šä½¿ç”¨ Node.js åº“å’Œ HTTP ä¸­é—´ä»¶ã€‚è¿™é¡¹åˆ›æ–°åœ¨è®©æˆ‘ä»¬èƒ½åˆ©ç”¨ NPM å’Œ Node.js ç”Ÿæ€çš„åŠ›é‡ï¼Œè€Œæ— éœ€ä»é›¶å¼€å§‹å®ç° web å…¼å®¹æ–¹é¢èµ·åˆ°äº†å…³é”®ä½œç”¨ã€‚H3 å’Œ unenv çš„ååŒç»„åˆæœ€ç»ˆè®© [Nitro](https://nitro.unjs.io) æˆä¸ºé¦–æ‰¹å®Œå…¨å…¼å®¹ Edge è¿è¡Œæ—¶çš„ç½‘ç»œæ¡†æ¶ä¹‹ä¸€ã€‚

æ­¤æ¬¡æœ€æ–°å‘å¸ƒè®© H3 æ›´è¿›ä¸€æ­¥ï¼Œèƒ½å¤Ÿå¼€ç®±å³ç”¨åœ°æä¾›åŸç”Ÿ Web API å…¼å®¹æ€§ã€‚

> ğŸš€ æœ¬ç‰ˆæœ¬å·²ç«‹å³é€‚ç”¨äºæ‰€æœ‰ç”Ÿæ€åŒ…ï¼ŒåŒ…æ‹¬ [Nitro](https://nitro.unjs.io/) å’Œ [Nuxt 3](https://nuxt.com/)ã€‚è¯·è®°å¾—åˆ·æ–°ä½ çš„ `lockfile` å’Œ `node_modules` ä»¥è·å–æ›´æ–°ã€‚

## Web å’Œ Plain é€‚é…å™¨

æˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªæ–°çš„å†…ç½®é€‚é…å™¨ï¼Œå…·æœ‰ [fetch](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API) å…¼å®¹çš„ç­¾åï¼Œä»¥ [Request](https://developer.mozilla.org/en-US/docs/Web/API/Request) ä½œä¸ºè¾“å…¥ï¼Œä»¥ [Response](https://developer.mozilla.org/en-US/docs/Web/API/Response) ä½œä¸ºè¿”å›å€¼ã€‚

è¿™æ„å‘³ç€ä½ ç°åœ¨å¯ä»¥æ— ç¼åœ°å°† H3 åº”ç”¨éƒ¨ç½²åˆ°è¯¸å¦‚ [Cloudflare Workers](https://workers.cloudflare.com/)ã€[Deno Deploy](https://deno.com/deploy)ã€[Bun](https://bun.sh/) å’Œ [Lagon](https://lagon.app/) ç­‰è¿è¡Œæ—¶ä¸Šã€‚

å…³äºå®é™…ç¤ºä¾‹å’Œæ¼”ç¤ºï¼Œè¯·æŸ¥çœ‹ [h3-on-edge](https://github.com/pi0/h3-on-edge) ä»“åº“ã€‚

```ts
// import { createApp, eventHandler, toWebHandler } from 'h3'
import { createApp, eventHandler, toWebHandler } from "https://esm.sh/h3@1.8.0";

const app = createApp();

app.use(
  "/",
  eventHandler((event) => "H3 works on edge!"),
);

const webHandler = toWebHandler(app); // (Request) => Promise<Response>
```

é™¤äº† web å¤„ç†å™¨ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¼•å…¥äº†ä¸€ç§æ–°çš„ plain é€‚é…å™¨æ ¼å¼ï¼Œä½¿ç”¨ `toPlainHandler(app)` è¯­æ³•ã€‚è¿™æœ‰åŠ©äºè®© H3 æ— ç¼é›†æˆä»»ä½•ä½¿ç”¨çº¯è¾“å…¥å’Œå“åº”å¯¹è±¡çš„æ— æœåŠ¡å™¨å¹³å°ã€‚

æ‰€æœ‰è¿™äº›éƒ½å¾—ç›Šäºæ–°æµåŠŸèƒ½çš„å®ç°ä»¥åŠ [unjs/unenv](https://unenv.unjs.io) æä¾›çš„è½»é‡çº§ Node.js å…¼å®¹å±‚ã€‚æ­¤å‰ï¼Œè¿™ç§é›†æˆçº§åˆ«åªèƒ½é€šè¿‡ [Nitro presets](https://nitro.unjs.io/deploy) å®ç°ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¼•å…¥äº†ä¸€ç»„æ–°çš„ web è¾…åŠ©å·¥å…·ï¼š

- `toWebRequest(event)`ï¼šå°† H3 äº‹ä»¶å¯¹è±¡è½¬æ¢æˆ web [Request](https://developer.mozilla.org/en-US/docs/Web/API/Request)ã€‚
- `getRequestWebStream(event)`ï¼šä»å½“å‰ H3 äº‹ä»¶è¯·æ±‚ä¸­è·å–å¯è¯»æµã€‚
- `fromPlainHandler(plainHandler)`ï¼šå°†çº¯å¯¹è±¡å¤„ç†å™¨è½¬æ¢ä¸ºå…¼å®¹ H3 çš„äº‹ä»¶å¤„ç†å™¨ã€‚
- `fromWebHandler(webHandler)`ï¼šå°† Web Request/Response å¤„ç†å™¨è½¬æ¢ä¸ºå…¼å®¹ H3 çš„äº‹ä»¶å¤„ç†å™¨ã€‚

## Web æµæ”¯æŒ

H3 ç°æ”¯æŒåŸç”Ÿ [Readable Stream](https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream) å“åº”æ”¯æŒã€‚è¿™è‡ªç„¶å¸¦æ¥äº†ä¸è¯¸å¦‚ä¾èµ–æµå“åº”çš„åº“ï¼ˆå¦‚ [Vercel/AI](https://github.com/vercel/ai)ï¼‰ ([æ¼”ç¤º](https://github.com/Hebilicious/nuxt-openai-vercel-edge-demo)) çš„å…¼å®¹æ€§ã€‚

åˆ©ç”¨æ­¤åŠŸèƒ½éå¸¸ç®€å• â€”â€” åªéœ€ä»ä½ çš„äº‹ä»¶å¤„ç†ç¨‹åºè¿”å›ä¸€ä¸ª [Readable Stream](https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream) æˆ– [Response](https://developer.mozilla.org/en-US/docs/Web/API/Response) å¯¹è±¡å³å¯ã€‚

```ts
export default defineHandler((event) => {
  setResponseHeader(event, "Content-Type", "text/html");
  const encoder = new TextEncoder();
  const stream = new ReadableStream({
    async start(controller) {
      for (const token of "Streaming is so cool with H3!".split(" ")) {
        controller.enqueue(encoder.encode(token));
        await new Promise((resolve) => {
          setTimeout(resolve, 300);
        });
      }
    },
  });
  return stream;
});
```

å¯¹äºæ›´é«˜çº§çš„åœºæ™¯ï¼Œä½ å¯èƒ½ä¼šé€‰æ‹©ä½¿ç”¨ `sendStream(event, stream)` å’Œ `sendWebResponse(event, stream)` å·¥å…·ï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›æµã€‚

## å¯¹è±¡è¯­æ³•äº‹ä»¶å¤„ç†å™¨

H3 ç°åœ¨æ”¯æŒé€šè¿‡å¯¹è±¡è¯­æ³•å®šä¹‰äº‹ä»¶å¤„ç†å™¨ã€‚é‡‡ç”¨è¯¥æ–¹æ³•ï¼Œä½ å¯ä»¥å®šä¹‰åœ¨æ¯ä¸ªå¤„ç†ç¨‹åºæ‰§è¡Œå‰åè¿è¡Œçš„é’©å­ï¼Œä¾‹å¦‚èº«ä»½éªŒè¯æˆ–å‹ç¼©ä¸­é—´ä»¶ã€‚

```ts
const auth = defineRequestMiddleware((event) => {
  event.context.auth = { name: "admin" };
});

const compression = defineResponseMiddleware((event) => {
  // ç¤ºä¾‹ï¼šhttps://stackblitz.com/edit/github-mb6bz3
});

export default eventHandler({
  onRequest: [auth],
  onResponse: [compression],
  async handler(event) {
    return `Hello ${event.context.auth?.name || "Guest"}`;
  },
});
```

## ç±»å‹åŒ–äº‹ä»¶å¤„ç†è¯·æ±‚

H3 ç°æ”¯æŒä½¿ç”¨æ–°çš„æ³›å‹ç±»å‹æ”¯æŒå®šä¹‰äº‹ä»¶ç±»å‹ã€‚

å®šä¹‰ç±»å‹åï¼Œè¯·æ±‚å·¥å…·å°†èƒ½æ„ŸçŸ¥äº‹ä»¶è¾“å…¥ç±»å‹ã€‚è¿™ä¸€å¢å¼ºè¿˜å…è®¸æˆ‘ä»¬æå‡ä¸Šæ¸¸æ¡†æ¶ï¼ˆå¦‚ [Nitro](https://nitro.unjs.io/) å’Œ [Nuxt](https://nuxt.com/)ï¼‰ä¸­ `$fetch` å¤„ç†å™¨çš„ç±»å‹å®‰å…¨ã€‚

```ts
export default eventHandler<{ body: { name: string }; query: { id: string } }>(
  async (event) => {
    const query = getQuery(event); // query è¢«ç±»å‹å®šä¹‰ä¸º { id: string }
    const body = await readBody(event); // body è¢«ç±»å‹å®šä¹‰ä¸º { name: string }
  },
);
```

## è¿è¡Œæ—¶ + ç±»å‹å®‰å…¨è¯·æ±‚å·¥å…·

æ–°å¢ä¸¤ä¸ªå®ç”¨å‡½æ•° `getValidatedQuery(event, validator)` å’Œ `readValidatedBody(event, validator)`ï¼Œä¾¿äºç»“åˆå¦‚ [zod](https://zod.dev/) è¿™ç±»æ¨¡å¼éªŒè¯å™¨ï¼Œå®ç°è¿è¡Œæ—¶å’Œç±»å‹å®‰å…¨ã€‚

```ts
import { z } from "zod";

const userSchema = z.object({
  name: z.string().default("Guest"),
  email: z.string().email(),
});

export default defineHandler(async (event) => {
  const result = await readValidatedBody(event, (body) =>
    userSchema.safeParse(body),
  ); // æˆ–ä½¿ç”¨ `.parse` ç›´æ¥æŠ›å‡ºé”™è¯¯

  if (!result.success) throw result.error.issues;

  // User å¯¹è±¡ç»è¿‡éªŒè¯ä¸”æœ‰ç±»å‹æ”¯æŒï¼
  return result.data;
});
```

## å…¶ä»–å®ç”¨å·¥å…·

æˆ‘ä»¬è¿˜å¼•å…¥äº†å¤šç§å…¶ä»–å·¥å…·ï¼Œè¿›ä¸€æ­¥æå‡ Web åº”ç”¨å¼€å‘ä½“éªŒï¼š

- `getRequestIP(event, { xForwardedFor? })`ï¼šè·å–ä¼ å…¥è¯·æ±‚çš„ IPã€‚
- `readFormData(event)`ï¼šå°†è¯·æ±‚ä½“è¯»å–ä¸º [FormData](https://developer.mozilla.org/en-US/docs/Web/API/FormData)ã€‚
- `clearResponseHeaders(event)`ï¼šæ¸…é™¤æ‰€æœ‰å“åº”å¤´ã€‚
- `removeResponseHeader(event, name)`ï¼šç§»é™¤æŒ‡å®šå“åº”å¤´ã€‚
- `serveStatic(event, options)`ï¼šå¹³å°æ— å…³çš„é™æ€èµ„æºæœåŠ¡å™¨ã€‚æŸ¥çœ‹ [listhen æºç ](https://github.com/unjs/listhen/blob/af6ea3af3fec4289c00b0ba589ca6f63c6a5dbbd/src/server/dev.ts#L66) äº†è§£å¦‚ä½•ä¸ Node.js ä¸€èµ·ä½¿ç”¨ç¤ºä¾‹ã€‚

## ä½¿ç”¨ HMR å®ç°è½»æ¾çš„ TypeScript å¼€å‘

æˆ‘ä»¬è¿˜å‘å¸ƒäº†æ›´æ–°ç‰ˆ [unjs/listhen](https://listhen.unjs.io)ï¼Œå¯ä¸ H3 åº”ç”¨æ— ç¼é›†æˆã€‚

ä½ åªéœ€åˆ›å»ºä¸€ä¸ª `index.ts` æ–‡ä»¶ï¼š

```ts
import { createApp, eventHandler } from "h3";

export const app = createApp();

app.use("/", () => "Hello world!");
```

è¿è¡Œ `npx listhen@latest -w ./index.ts` å¯åŠ¨æ”¯æŒ TypeScriptã€çƒ­æ¨¡å—æ›¿æ¢ (HMR) å’Œé™æ€èµ„æºæœåŠ¡å™¨çš„å¼€å‘æœåŠ¡å™¨ã€‚

[åœ¨çº¿è¯•ç©](https://stackblitz.com/github/unjs/h3/tree/main/playground?startScript=dev)

![listhen æˆªå›¾](https://raw.githubusercontent.com/unjs/listhen/main/.assets/screenshot.png){withoutBorder}

## å®Œæ•´æ›´æ–°æ—¥å¿—

æ¬²äº†è§£è¯¦ç»†å˜æ›´åˆ—è¡¨ï¼Œè¯·å‚é˜… [å‘å¸ƒè¯´æ˜](https://github.com/unjs/h3/releases/tag/v1.8.0)ã€‚