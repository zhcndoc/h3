---
icon: cib:socket-io
---

# WebSockets

> H3 å†…ç½®æ”¯æŒè·¨å¹³å°çš„ WebSocket å’ŒæœåŠ¡å™¨å‘é€äº‹ä»¶ã€‚

H3 ä½¿ç”¨ [ğŸ”Œ CrossWS](https://crossws.unjs.io/) æä¾›å†…ç½®çš„ã€è¿è¡Œæ—¶æ— å…³çš„ [WebSocket](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket) æ”¯æŒã€‚

:read-more{title="CrossWS" to="https://crossws.unjs.io/"}

> [!IMPORTANT]
> h3 v2 å¯¹ WebSockets çš„å†…ç½®æ”¯æŒä»åœ¨å¼€å‘ä¸­ã€‚

## ä½¿ç”¨æ–¹æ³•

<!-- automd:file code lang="js" src="../../examples/websocket.mjs" -->

```js [websocket.mjs]
import { H3, serve, proxy, defineWebSocketHandler } from "h3";

export const app = new H3();

const websocketDemoURL =
  "https://raw.githubusercontent.com/unjs/crossws/main/examples/h3/public/index.html";

app.get("/", (event) =>
  proxy(event, websocketDemoURL, { headers: { "Content-Type": "text/html" } }),
);

app.use(
  "/_ws",
  defineWebSocketHandler({
    open(peer) {
      console.log("[ws] open", peer);
    },

    message(peer, message) {
      console.log("[ws] message", peer, message);
      if (message.text().includes("ping")) {
        peer.send("pong");
      }
    },

    close(peer, event) {
      console.log("[ws] close", peer, event);
    },

    error(peer, error) {
      console.log("[ws] error", peer, error);
    },
  }),
);

serve(app);
```

<!-- /automd -->

## æœåŠ¡å™¨å‘é€äº‹ä»¶ï¼ˆSSEï¼‰

ä½œä¸º WebSockets çš„æ›¿ä»£æ–¹æ¡ˆï¼Œæ‚¨å¯ä»¥ä½¿ç”¨[æœåŠ¡å™¨å‘é€äº‹ä»¶](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events)ã€‚

H3 æä¾›å†…ç½® APIï¼Œå¯ä½¿ç”¨ `createEventStream(event)` å·¥å…·åˆ›å»ºæœåŠ¡å™¨å‘é€äº‹ä»¶ã€‚

### ç¤ºä¾‹

<!-- automd:file code lang="js" src="../../examples/server-sent-events.mjs" -->

```js [server-sent-events.mjs]
import { H3, serve, createEventStream } from "h3";

export const app = new H3();

app.get("/", (event) => {
  const eventStream = createEventStream(event);

  // æ¯ç§’å‘é€ä¸€æ¡æ¶ˆæ¯
  const interval = setInterval(async () => {
    await eventStream.push("Hello world");
  }, 1000);

  // å½“è¿æ¥å…³é—­æˆ–å†™å…¥å™¨å…³é—­æ—¶æ¸…ç†å®šæ—¶å™¨
  eventStream.onClosed(() => {
    console.log("è¿æ¥å·²å…³é—­");
    clearInterval(interval);
  });

  return eventStream.send();
});

serve(app);
```

<!-- /automd -->