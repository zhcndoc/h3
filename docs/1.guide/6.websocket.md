---
icon: cib:socket-io
---

# WebSockets

> H3 å†…ç½®è·¨å¹³å° WebSocket å’ŒæœåŠ¡å™¨å‘é€äº‹ä»¶çš„å®ç”¨å·¥å…·ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ [ğŸ”Œ CrossWS](https://crossws.h3.dev/) ä¸º H3 æœåŠ¡å™¨æ·»åŠ è·¨å¹³å° WebSocket æ”¯æŒã€‚

> [!IMPORTANT]
> h3 ç‰ˆæœ¬ä¸­å†…ç½®çš„ WebSockets æ”¯æŒä»åœ¨å¼€å‘ä¸­ã€‚

## ç”¨æ³•

WebSocket å¤„ç†ç¨‹åºå¯ä»¥ä½¿ç”¨ `defineWebSocketHandler()` å·¥å…·å®šä¹‰ï¼Œå¹¶åƒäº‹ä»¶å¤„ç†ç¨‹åºä¸€æ ·æ³¨å†Œåˆ°ä»»æ„è·¯ç”±ã€‚

æ‚¨éœ€è¦åœ¨ `serve` å‡½æ•°ä¸­å°† CrossWS æ³¨å†Œä¸ºæœåŠ¡å™¨æ’ä»¶ï¼Œå¹¶æä¾›ä¸€ä¸ª `resolve` å‡½æ•°ä»¥ä»è·¯ç”±ä¸­è§£ææ­£ç¡®çš„é’©å­ã€‚

```js
import { H3, serve, defineWebSocketHandler } from "h3";

import { plugin as ws } from "crossws/server";

const app = new H3()

app.get("/_ws", defineWebSocketHandler({ message: console.log }));

serve(app, {
  plugins: [ws({ resolve: async (req) => (await app.fetch(req)).crossws })],
});
```

**å®Œæ•´ç¤ºä¾‹ï¼š**

<!-- automd:file code lang="js" src="../../examples/websocket.mjs" -->

```js [websocket.mjs]
import { H3, serve, defineWebSocketHandler } from "h3";
import { plugin as ws } from "crossws/server";

export const app = new H3();

const demoURL =
  "https://raw.githubusercontent.com/h3js/crossws/refs/heads/main/playground/public/index.html";

app.get("/", () =>
  fetch(demoURL).then(
    (res) =>
      new Response(res.body, { headers: { "Content-Type": "text/html" } }),
  ),
);

app.get(
  "/_ws",
  defineWebSocketHandler({
    // upgrade(req) {},
    open(peer) {
      console.log("[open]", peer);

      // å‘æ–°å®¢æˆ·ç«¯å‘é€æ¬¢è¿ä¿¡æ¯
      peer.send("Welcome to the server!");

      // å°†æ–°å®¢æˆ·ç«¯åŠ å…¥â€œchatâ€é¢‘é“
      peer.subscribe("chat");

      // é€šçŸ¥æ‰€æœ‰å…¶ä»–å·²è¿æ¥å®¢æˆ·ç«¯
      peer.publish("chat", `[system] ${peer} joined!`);
    },

    message(peer, message) {
      console.log("[message]", peer);

      if (message.text() === "ping") {
        // å‘å®¢æˆ·ç«¯å›å¤ ping å“åº”
        peer.send("pong");
        return;
      }

      // æœåŠ¡å™¨å°†æ”¶åˆ°çš„æ¶ˆæ¯é‡æ–°å¹¿æ’­ç»™æ‰€æœ‰äºº
      peer.publish("chat", `[${peer}] ${message}`);

      // å°†æ¶ˆæ¯å›æ˜¾ç»™å‘é€è€…
      peer.send(message);
    },

    close(peer) {
      console.log("[close]", peer);
      peer.publish("chat", `[system] ${peer} has left the chat!`);
      peer.unsubscribe("chat");
    },
  }),
);

serve(app, {
  plugins: [ws({ resolve: async (req) => (await app.fetch(req)).crossws })],
});
```

<!-- /automd -->

## æœåŠ¡å™¨å‘é€äº‹ä»¶ï¼ˆSSEï¼‰

ä½œä¸º WebSockets çš„æ›¿ä»£æ–¹æ¡ˆï¼Œæ‚¨å¯ä»¥ä½¿ç”¨[æœåŠ¡å™¨å‘é€äº‹ä»¶](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events)ã€‚

H3 æä¾›å†…ç½® APIï¼Œå¯ä½¿ç”¨ `createEventStream(event)` å·¥å…·åˆ›å»ºæœåŠ¡å™¨å‘é€äº‹ä»¶ã€‚

### ç¤ºä¾‹

<!-- automd:file code lang="js" src="../../examples/server-sent-events.mjs" -->

```js [server-sent-events.mjs]
import { H3, serve, createEventStream } from "h3";

export const app = new H3();

app.get("/", (event) => {
  const eventStream = createEventStream(event);

  // æ¯ç§’å‘é€ä¸€æ¡æ¶ˆæ¯
  const interval = setInterval(async () => {
    await eventStream.push("Hello world");
  }, 1000);

  // å½“è¿æ¥å…³é—­æˆ–å†™å…¥å™¨å…³é—­æ—¶æ¸…ç†å®šæ—¶å™¨
  eventStream.onClosed(() => {
    console.log("è¿æ¥å·²å…³é—­");
    clearInterval(interval);
  });

  return eventStream.send();
});

serve(app);
```

<!-- /automd -->